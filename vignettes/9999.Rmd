---
title: "exercise9"
author: "Shiyuan"
date: "2025-03-25"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE,results="show")

# 加载必要的包
library(readr)
library(dplyr)
library(broom)
library(ggplot2)
library(knitr)
library(tibble)
library(purrr)
library(cowplot)
library(here)
# 读取数据
data <- read_csv(here("data_raw/df_for_stepwise_regression.csv"))  # 请确保该路径在您的仓库中有效

# 指定响应变量
response <- "GPP_NT_VUT_REF"
predictors <- setdiff(names(data), response)

# 仅保留数值型预测变量
numeric_predictors <- predictors[sapply(data[predictors], is.numeric)]

# 填补缺失值并标准化数值型预测变量
data_clean <- data %>%
  mutate(across(where(is.numeric), ~ifelse(is.na(.), mean(., na.rm = TRUE), .))) %>%
  mutate(across(all_of(numeric_predictors), ~as.numeric(scale(.))))

# 拟合所有单变量模型
single_models <- lapply(numeric_predictors, function(pred) {
  formula <- as.formula(paste(response, "~", pred))
  model <- lm(formula, data = data_clean)
  tibble(
    predictor = pred,
    r_squared = summary(model)$r.squared,
    aic = AIC(model),
    model = list(model)
  )
}) %>%
  bind_rows()

# 找出 R² 最大的模型
best_model_info <- single_models %>%
  arrange(desc(r_squared)) %>%
  slice(1)

best_model_info %>%
  select(predictor, r_squared, aic) %>%
  knitr::kable(caption = "R²最高的单变量模型")

par(mfrow = c(2, 2))
plot(best_model_info$model[[1]])
par(mfrow = c(1, 1))

summary(best_model_info$model[[1]]) %>%
  tidy() %>%
  knitr::kable(digits = 4, caption = "最佳模型的系数估计")

# 为每个模型创建图
model_plots <- lapply(single_models$predictor, function(pred) {
  ggplot(data_clean, aes_string(x = pred, y = response)) +
    geom_point(size = 0.75) +
    geom_smooth(method = "lm", color = "red", fullrange = TRUE) +
    labs(
      title = paste("Linear model:", response, "vs", pred),
      x = pred,
      y = response
    ) +
    theme_classic()
})

p <-plot_grid(
  plotlist = model_plots,
  ncol=3
) 

ggsave(
 here("figures","chapter9_combined_plot.png"),
 plot = p,
 width = 10,
 height=15
)

knitr::include_graphics(here("figures","chapter9_combined_plot.png"))
  
```


